# DingTalk 插件升级通知 (v0.1.0 → v1.2.0)

## 📢 重要更新

DingTalk 插件已发布 v1.2.0 官方版本，支持通过 NPM 安装！

## 🎯 最简单的升级方法（推荐）

**只需一条命令**，自动完成所有升级步骤：

```bash
curl -fsSL https://raw.githubusercontent.com/yaoyuanchao/dingtalk-clawdbot/main/upgrade-from-v0.1.0.sh | bash
```

**升级时间**: 不到 1 分钟
**配置保留**: 自动备份和恢复，staffId 白名单、群聊白名单等全部保留
**零停机**: 自动停止和重启 Gateway

---

## 📋 脚本会做什么？

✅ 自动备份你的配置文件
✅ 删除旧版本代码
✅ 安装官方 NPM 版本 (v1.2.0)
✅ 恢复你的配置
✅ 验证安装是否成功

---

## 🎁 升级后的新功能

### 1. 官方 NPM 安装
```bash
clawdbot plugins install @yaoyuanchao/dingtalk
```
不再需要手动复制代码！

### 2. 交互式配置向导
```bash
clawdbot onboard --channel dingtalk
```
自动测试连接，引导你完成所有设置！

### 3. 类型安全验证
配置错误时会给出详细提示：
```
DingTalk config validation failed:
  - clientId: Client ID (AppKey) is required
  - dm.policy: Invalid enum value
```

### 4. 健康检查
```bash
clawdbot status --deep
```
自动显示连接状态和延迟！

### 5. 简化的后续升级
以后升级只需一条命令：
```bash
clawdbot plugins update @yaoyuanchao/dingtalk
```

---

## ⚠️ 升级前须知

### 完全兼容 v0.1.0

- ✅ 所有配置项格式相同
- ✅ clientId、clientSecret 无需修改
- ✅ staffId 白名单保持有效
- ✅ 群聊白名单保持有效
- ✅ messageFormat 配置（包括 "richtext"）完全兼容

### 升级建议

- 📅 在非工作时间进行（虽然很快）
- 💾 会自动备份，但建议自己也备份一份
- 🔍 升级后查看日志确认连接正常

---

## 🚀 开始升级

### 方法 1: 一键升级（最推荐）

```bash
# 下载并运行升级脚本
curl -fsSL https://raw.githubusercontent.com/yaoyuanchao/dingtalk-clawdbot/main/upgrade-from-v0.1.0.sh | bash
```

### 方法 2: 下载脚本后运行

```bash
# 下载脚本
curl -fsSL https://raw.githubusercontent.com/yaoyuanchao/dingtalk-clawdbot/main/upgrade-from-v0.1.0.sh -o /tmp/upgrade.sh

# 查看脚本内容（可选，确保安全）
cat /tmp/upgrade.sh

# 运行升级
bash /tmp/upgrade.sh
```

### 方法 3: 手动升级（3 步）

```bash
# 1. 备份配置
cp ~/.clawdbot/clawdbot.json ~/.clawdbot/clawdbot.json.backup

# 2. 删除旧版本
rm -rf ~/.clawdbot/extensions/dingtalk

# 3. 安装新版本
clawdbot plugins install @yaoyuanchao/dingtalk
```

**注意**: 手动升级后需要恢复配置文件中的 dingtalk 配置。

---

## ✅ 升级后验证

```bash
# 1. 检查插件版本
clawdbot plugins list | grep dingtalk
# 应该显示: 1.2.0

# 2. 启动 Gateway
clawdbot gateway

# 3. 查看日志
tail -f /tmp/clawdbot/clawdbot-$(date +%Y-%m-%d).log | grep dingtalk
# 应该看到: [dingtalk:default] Stream connected
```

---

## 🆘 遇到问题？

### 常见问题

**Q: 升级会影响正在运行的机器人吗？**
A: 脚本会自动停止和重启 Gateway，停机时间不到 1 分钟。

**Q: 配置会丢失吗？**
A: 不会！脚本会自动备份和恢复所有配置。

**Q: 升级失败怎么办？**
A: 脚本会自动恢复备份，或手动运行：
```bash
cp ~/.clawdbot/clawdbot.json.backup ~/.clawdbot/clawdbot.json
```

**Q: 可以回滚到旧版本吗？**
A: 可以，但需要手动重新安装 v0.1.0 代码。

### 获取帮助

- 📖 详细文档: https://github.com/akedia/dingtalk-clawdbot
- 📚 升级指南: [UPGRADE.md](./UPGRADE.md)
- 🔧 兼容性说明: [COMPATIBILITY.md](./COMPATIBILITY.md)
- 🐛 问题反馈: https://github.com/akedia/dingtalk-clawdbot/issues

---

## 📊 版本对比

| 功能 | v0.1.0 | v1.2.0 |
|------|--------|--------|
| 安装方式 | 手动复制代码 | NPM 一键安装 ✨ |
| 配置验证 | JSON Schema | Zod 类型安全 ✨ |
| 配置向导 | ❌ | ✅ 交互式 ✨ |
| 健康检查 | ❌ | ✅ 延迟监控 ✨ |
| 升级方式 | 手动替换文件 | `npm update` ✨ |
| 错误提示 | 模糊 | 详细定位 ✨ |
| Stream 连接 | ✅ | ✅ |
| 私聊/群聊 | ✅ | ✅ |
| 图片接收 | ✅ | ✅ |
| 访问控制 | ✅ | ✅ |

---

## 💡 升级后试试新功能

### 使用配置向导重新配置（可选）

```bash
clawdbot onboard --channel dingtalk
```

### 查看健康状态

```bash
clawdbot status --deep
```

### 测试连接

在钉钉中发送消息给机器人，查看日志：
```bash
tail -f /tmp/clawdbot/clawdbot-$(date +%Y-%m-%d).log | grep dingtalk
```

---

**建议**: 如果升级顺利，可以删除备份文件（但建议保留几天）：
```bash
ls -lh ~/.clawdbot/clawdbot.json.backup*
```

---

**最后**: 感谢使用 DingTalk 插件！如果觉得有帮助，欢迎 ⭐ Star 项目！

🔗 项目地址: https://github.com/akedia/dingtalk-clawdbot
📦 NPM 地址: https://www.npmjs.com/package/@yaoyuanchao/dingtalk
