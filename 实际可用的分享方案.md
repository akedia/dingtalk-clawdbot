# å®é™…å¯ç”¨çš„è€ç”¨æˆ·å‡çº§æ–¹æ¡ˆ

## é—®é¢˜è¯´æ˜

ç›®å‰ä»£ç åªåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒ (`E:\dingtalkclawd`)ï¼Œè¿˜æ²¡æœ‰æ¨é€åˆ° GitHubï¼Œæ‰€ä»¥ä¹‹å‰æ–‡æ¡£ä¸­çš„ GitHub é“¾æ¥éƒ½æ— æ³•è®¿é—®ã€‚

## âœ… æ–¹æ¡ˆ 1ï¼šé€šè¿‡å†…ç½‘æœåŠ¡å™¨åˆ†äº«ï¼ˆæ¨èï¼‰

### éƒ¨ç½²å‡çº§è„šæœ¬åˆ°è¿œç«¯æœåŠ¡å™¨

```bash
# 1. ä¸Šä¼ å‡çº§è„šæœ¬åˆ°è¿œç«¯
scp /e/dingtalkclawd/upgrade-from-v0.1.0.sh root@172.20.90.45:/tmp/

# 2. è®¾ç½®å¯æ‰§è¡Œæƒé™
ssh root@172.20.90.45 "chmod +x /tmp/upgrade-from-v0.1.0.sh"
```

### è€ç”¨æˆ·ä½¿ç”¨æ–¹å¼

**ä¸€é”®å‡çº§å‘½ä»¤**ï¼ˆé€šè¿‡å†…ç½‘æœåŠ¡å™¨ï¼‰ï¼š
```bash
# ä»ä½ çš„æœåŠ¡å™¨ä¸‹è½½å¹¶æ‰§è¡Œ
curl -fsSL http://172.20.90.45/upgrade-from-v0.1.0.sh | bash

# æˆ–è€…é€šè¿‡ scp ä¸‹è½½
scp root@172.20.90.45:/tmp/upgrade-from-v0.1.0.sh /tmp/
bash /tmp/upgrade-from-v0.1.0.sh
```

---

## âœ… æ–¹æ¡ˆ 2ï¼šç›´æ¥æä¾›è„šæœ¬æ–‡ä»¶

### å‡†å¤‡åˆ†äº«åŒ…

```bash
cd /e/dingtalkclawd

# åˆ›å»ºåˆ†äº«åŒ…
tar czf dingtalk-upgrade-kit.tar.gz \
  upgrade-from-v0.1.0.sh \
  åˆ†äº«ç»™è€ç”¨æˆ·.md \
  QUICK-UPGRADE.md \
  UPGRADE.md \
  COMPATIBILITY.md

echo "åˆ†äº«åŒ…å·²åˆ›å»º: dingtalk-upgrade-kit.tar.gz"
```

### å‘ç»™ç”¨æˆ·

**é€šè¿‡é’‰é’‰/å¾®ä¿¡/é‚®ä»¶å‘é€** `dingtalk-upgrade-kit.tar.gz`

ç”¨æˆ·æ“ä½œï¼š
```bash
# 1. è§£å‹
tar xzf dingtalk-upgrade-kit.tar.gz

# 2. æŸ¥çœ‹è¯´æ˜
cat åˆ†äº«ç»™è€ç”¨æˆ·.md

# 3. è¿è¡Œå‡çº§
bash upgrade-from-v0.1.0.sh
```

---

## âœ… æ–¹æ¡ˆ 3ï¼šç›´æ¥ NPM å®‰è£…ï¼ˆæœ€ç®€å•ï¼Œæ— éœ€è„šæœ¬ï¼‰

å› ä¸ºå·²ç»å‘å¸ƒåˆ° NPMï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥è¿™æ ·æ“ä½œï¼š

### ç»™ç”¨æˆ·çš„å®Œæ•´æ­¥éª¤ï¼ˆæ— éœ€è„šæœ¬ï¼‰

```bash
# æ­¥éª¤ 1: å¤‡ä»½é…ç½®
cp ~/.clawdbot/clawdbot.json ~/.clawdbot/clawdbot.json.backup-$(date +%Y%m%d)

# æ­¥éª¤ 2: ä¿å­˜ DingTalk é…ç½®
python3 << 'EOF'
import json
with open(f"{__import__('os').path.expanduser('~')}/.clawdbot/clawdbot.json", 'r') as f:
    config = json.load(f)
dt = config.get('channels', {}).get('dingtalk', {})
if dt:
    with open('/tmp/dt-config.json', 'w') as f:
        json.dump(dt, f, indent=2)
    print("é…ç½®å·²ä¿å­˜")
EOF

# æ­¥éª¤ 3: åœæ­¢ gateway
pkill -f "clawdbot gateway" || true
sleep 2

# æ­¥éª¤ 4: åˆ é™¤æ—§ç‰ˆæœ¬
rm -rf ~/.clawdbot/extensions/dingtalk

# æ­¥éª¤ 5: ä¸´æ—¶æ¸…ç†é…ç½®å¼•ç”¨
python3 << 'EOF'
import json
import os
cfg_file = f"{os.path.expanduser('~')}/.clawdbot/clawdbot.json"
with open(cfg_file, 'r') as f:
    config = json.load(f)
config.get('channels', {}).pop('dingtalk', None)
if 'plugins' in config and 'entries' in config['plugins']:
    config['plugins']['entries'].pop('dingtalk', None)
with open(cfg_file, 'w') as f:
    json.dump(config, f, indent=2)
print("é…ç½®å·²æ¸…ç†")
EOF

# æ­¥éª¤ 6: å®‰è£…æ–°ç‰ˆæœ¬
clawdbot plugins install @yaoyuanchao/dingtalk

# æ­¥éª¤ 7: æ¢å¤é…ç½®
python3 << 'EOF'
import json
import os
cfg_file = f"{os.path.expanduser('~')}/.clawdbot/clawdbot.json"
with open(cfg_file, 'r') as f:
    config = json.load(f)
try:
    with open('/tmp/dt-config.json', 'r') as f:
        dt = json.load(f)
    if 'channels' not in config:
        config['channels'] = {}
    config['channels']['dingtalk'] = dt
    if 'plugins' not in config:
        config['plugins'] = {}
    if 'entries' not in config['plugins']:
        config['plugins']['entries'] = {}
    config['plugins']['entries']['dingtalk'] = {'enabled': True}
    with open(cfg_file, 'w') as f:
        json.dump(config, f, indent=2)
    print("é…ç½®å·²æ¢å¤")
except:
    print("æ¢å¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä»å¤‡ä»½æ¢å¤")
EOF

# æ­¥éª¤ 8: éªŒè¯å’Œå¯åŠ¨
clawdbot doctor
clawdbot gateway
```

---

## âœ… æ–¹æ¡ˆ 4ï¼šåˆ›å»º GitHub ä»“åº“ï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

å¦‚æœè¦å…¬å¼€åˆ†äº«ï¼Œéœ€è¦å…ˆåˆ›å»º GitHub ä»“åº“ï¼š

### åˆ›å»ºä»“åº“æ­¥éª¤

```bash
cd /e/dingtalkclawd

# 1. å¦‚æœè¿˜æ²¡æœ‰ GitHub ä»“åº“ï¼Œå…ˆåˆ›å»º
# å» https://github.com/new åˆ›å»ºä¸€ä¸ªæ–°ä»“åº“
# åç§°: dingtalk-clawdbot

# 2. æ·»åŠ è¿œç¨‹ä»“åº“
git remote add origin https://github.com/akedia/dingtalk-clawdbot.git

# 3. æ¨é€ä»£ç 
git push -u origin main
```

### æ¨é€åç”¨æˆ·å°±èƒ½ç”¨äº†

```bash
# å‡çº§è„šæœ¬å¯ç”¨
curl -fsSL https://raw.githubusercontent.com/akedia/dingtalk-clawdbot/main/upgrade-from-v0.1.0.sh | bash

# æ–‡æ¡£å¯è®¿é—®
https://github.com/akedia/dingtalk-clawdbot
```

---

## ğŸ“ æ¨èçš„å®é™…åˆ†äº«å†…å®¹

### ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼ˆæ–¹æ¡ˆ 3 - æœ€ç®€å•ï¼‰

```
ã€DingTalk æ’ä»¶å‡çº§é€šçŸ¥ v1.2.0ã€‘

æ’ä»¶å·²å‘å¸ƒåˆ° NPMï¼Œæ”¯æŒå®˜æ–¹å®‰è£…ï¼

ğŸš€ å‡çº§æ–¹æ³•ï¼ˆæ¨èï¼‰ï¼š

1. å¤‡ä»½é…ç½®ï¼š
cp ~/.clawdbot/clawdbot.json ~/.clawdbot/clawdbot.json.backup

2. åˆ é™¤æ—§ç‰ˆæœ¬ï¼š
rm -rf ~/.clawdbot/extensions/dingtalk

3. å®‰è£…æ–°ç‰ˆæœ¬ï¼š
clawdbot plugins install @yaoyuanchao/dingtalk

4. æ¢å¤é…ç½®ï¼ˆä»å¤‡ä»½ä¸­å¤åˆ¶ channels.dingtalk é…ç½®å›æ¥ï¼‰

5. å¯åŠ¨ï¼š
clawdbot gateway

âœ… é…ç½®å®Œå…¨å…¼å®¹ï¼ŒstaffId ç™½åå•ä¿æŒæœ‰æ•ˆ
âœ¨ æ–°å¢ï¼šé…ç½®å‘å¯¼ã€å¥åº·æ£€æŸ¥ã€ç±»å‹éªŒè¯

è¯¦ç»†æ­¥éª¤è§é™„ä»¶æˆ–è”ç³»æˆ‘
```

### é™„ä¸Šæ–‡ä»¶

ä» `E:\dingtalkclawd\` æ‰“åŒ…è¿™äº›æ–‡ä»¶å‘ç»™ç”¨æˆ·ï¼š
- `åˆ†äº«ç»™è€ç”¨æˆ·.md`
- `upgrade-from-v0.1.0.sh`
- `QUICK-UPGRADE.md`

---

## ğŸ¯ å½“å‰æœ€å®ç”¨çš„æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **æ–¹æ¡ˆ 3: ç›´æ¥æ­¥éª¤** | ä¸ä¾èµ–å¤–éƒ¨èµ„æº | æ­¥éª¤ç¨å¤šï¼ˆ8æ­¥ï¼‰ | â­â­â­â­â­ |
| æ–¹æ¡ˆ 2: åˆ†äº«åŒ… | åŒ…å«å®Œæ•´æ–‡æ¡£ | éœ€è¦ä¼ æ–‡ä»¶ | â­â­â­â­ |
| æ–¹æ¡ˆ 1: å†…ç½‘æœåŠ¡å™¨ | ä¸€é”®æ‰§è¡Œ | éœ€è¦é…ç½®HTTPæœåŠ¡ | â­â­â­ |
| æ–¹æ¡ˆ 4: GitHub | æœ€æ ‡å‡† | éœ€è¦å…ˆåˆ›å»ºä»“åº“ | â­â­ |

---

## âš¡ ç«‹å³å¯ç”¨çš„å‡çº§å‘½ä»¤ï¼ˆå¤åˆ¶ç»™ç”¨æˆ·ï¼‰

### æœ€ç®€ç‰ˆæœ¬ï¼ˆ3 æ­¥ï¼‰

```bash
# 1. å¤‡ä»½
cp ~/.clawdbot/clawdbot.json ~/.clawdbot/clawdbot.json.backup-$(date +%Y%m%d)

# 2. åˆ é™¤æ—§ç‰ˆæœ¬å¹¶å®‰è£…æ–°ç‰ˆæœ¬
rm -rf ~/.clawdbot/extensions/dingtalk && \
clawdbot plugins install @yaoyuanchao/dingtalk

# 3. æ‰‹åŠ¨æ¢å¤é…ç½®
# ç¼–è¾‘ ~/.clawdbot/clawdbot.json
# ä» ~/.clawdbot/clawdbot.json.backup-YYYYMMDD å¤åˆ¶ channels.dingtalk é…ç½®å›æ¥
# æ·»åŠ  plugins.entries.dingtalk: {"enabled": true}
```

ç„¶åå¯åŠ¨ï¼š
```bash
clawdbot gateway
```

---

## ğŸ”§ æˆ‘æ¥å¸®ä½ åšä»€ä¹ˆï¼Ÿ

é€‰æ‹©ä¸€ä¸ªæ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

1. **åˆ›å»ºåˆ†äº«åŒ…** - æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶ä¾›ä½ å‘ç»™ç”¨æˆ·
2. **éƒ¨ç½²åˆ°å†…ç½‘æœåŠ¡å™¨** - ä¸Šä¼ è„šæœ¬åˆ° 172.20.90.45
3. **åˆ›å»º GitHub ä»“åº“** - æ¨é€ä»£ç åˆ° GitHub
4. **ç”Ÿæˆç®€åŒ–ç‰ˆè¯´æ˜** - åªåŒ…å«å¿…è¦æ­¥éª¤çš„ç®€å•æ–‡æ¡£

ä½ æƒ³ç”¨å“ªä¸ªæ–¹æ¡ˆï¼Ÿ
